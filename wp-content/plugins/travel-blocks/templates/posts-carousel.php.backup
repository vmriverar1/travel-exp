<?php
/**
 * Template: Posts Carousel (Material Design)
 *
 * Desktop: Grid 3 columnas con hover effect
 * Mobile: Slider Material Design
 * ACF Repeater para control manual
 *
 * @var array $data Block data and settings
 */

// Log template start
if (function_exists('travel_info')) {
    travel_info('Template posts-carousel iniciado', [
        'data_keys' => array_keys($data),
    ]);
}

// Get cards from data
$cards = $data['cards'] ?? [];

if (function_exists('travel_info')) {
    travel_info('Cards en template', [
        'count' => count($cards),
        'is_array' => is_array($cards),
    ]);
}

// Get card style and global settings
$card_style = $data['card_style'] ?? 'default';
$button_color_variant = $data['button_color_variant'] ?? 'primary';
$badge_color_variant = $data['badge_color_variant'] ?? 'secondary';
$content_alignment = $data['content_alignment'] ?? 'left';

if (function_exists('travel_info')) {
    travel_info('Card style en template', [
        'style' => $card_style,
    ]);
}

// If no cards, don't render
if (empty($cards)) {
    if (function_exists('travel_warning')) {
        travel_warning('Template sin cards para renderizar');
    }

    if (defined('WP_DEBUG') && WP_DEBUG) {
        echo '<div style="padding: 20px; background: #f0f0f0; border: 2px dashed #ccc; text-align: center;">';
        echo '<p>Posts Carousel: Sin cards para mostrar. Agrega cards desde el panel de ACF.</p>';
        echo '</div>';
    }
    return;
}

// Block classes
$classes = [
    'posts-carousel',
    'posts-carousel--material',
    'posts-carousel--' . $card_style,
    'align' . $data['align'],
    'hover-' . $data['hover_effect'],
    'arrows-' . $data['arrows_position'],
    'content-align-' . $content_alignment,
];

// Slider settings (solo mobile)
$slider_settings = [
    'autoplay' => $data['autoplay'] ? '1' : '0',
    'delay' => $data['autoplay_delay'],
    'speed' => $data['slider_speed'],
];
?>

<section
    id="<?php echo esc_attr($data['block_id']); ?>"
    class="<?php echo esc_attr(implode(' ', $classes)); ?>"
    data-slider-autoplay="<?php echo esc_attr($slider_settings['autoplay']); ?>"
    data-slider-delay="<?php echo esc_attr($slider_settings['delay']); ?>"
    data-slider-speed="<?php echo esc_attr($slider_settings['speed']); ?>"
    style="--card-gap: <?php echo esc_attr($data['card_gap']); ?>px; --desktop-columns: <?php echo esc_attr($data['desktop_columns']); ?>; --tablet-columns: <?php echo esc_attr($data['tablet_columns']); ?>; --card-height: <?php echo esc_attr($data['card_height']); ?>px;">

    <!-- Wrapper para slider + dots -->
    <div class="pc-wrapper">

        <!-- Grid Container (Desktop) / Slider Container (Mobile) -->
        <div class="pc-container">

            <!-- Mobile Navigation Arrows (solo si no es 'bottom') -->
            <?php if ($data['show_arrows'] && $data['arrows_position'] !== 'bottom'): ?>
                <button class="pc-arrow pc-arrow--prev" aria-label="<?php esc_attr_e('Anterior', 'travel-blocks'); ?>">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                        <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
                <button class="pc-arrow pc-arrow--next" aria-label="<?php esc_attr_e('Siguiente', 'travel-blocks'); ?>">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                        <path d="M9 18L15 12L9 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
            <?php endif; ?>

            <!-- Cards Grid/Slider -->
            <div class="pc-grid">
            <?php foreach ($cards as $index => $card):
                // Get common card data
                $image_url = !empty($card['image']['url'])
                    ? $card['image']['url']
                    : 'https://picsum.photos/800/600?random=' . ($index + 1);

                $title = $card['title'] ?? __('Sin título', 'travel-blocks');
                $excerpt = $card['excerpt'] ?? '';
                $link = $card['link'] ?? '#';

                // Card image alt text
                $image_alt = !empty($card['image']['alt'])
                    ? $card['image']['alt']
                    : $title;
            ?>

            <?php if ($card_style === 'travel'):
                // Travel style - Imagen completa con precio y ubicación
                $location = !empty($card['location']) ? $card['location'] : '';
                $price = !empty($card['price']) ? $card['price'] : '';
                $old_price = !empty($card['old_price']) ? $card['old_price'] : '';
                $button_text = !empty($card['button_text']) ? $card['button_text'] : __('Ver detalles', 'travel-blocks');
                $badge_text = !empty($card['badge_text']) ? $card['badge_text'] : '';
            ?>

            <article class="pc-card pc-card--travel" data-index="<?php echo $index; ?>">
                <!-- Card Image Background -->
                <div class="pc-card__image-bg" style="background-image: url('<?php echo esc_url($image_url); ?>');">
                    <img
                        src="<?php echo esc_url($image_url); ?>"
                        alt="<?php echo esc_attr($image_alt); ?>"
                        loading="lazy"
                        style="display: none;">
                </div>

                <!-- Badge superior izquierda -->
                <?php if ($badge_text): ?>
                    <span class="pc-card__badge-travel pc-card__badge-travel--<?php echo esc_attr($badge_color_variant); ?>"><?php echo esc_html($badge_text); ?></span>
                <?php endif; ?>

                <!-- Favorite Button (Heart) -->
                <button class="pc-card__favorite" aria-label="<?php esc_attr_e('Agregar a favoritos', 'travel-blocks'); ?>">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                        <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>

                <!-- Card Content (Bottom) -->
                <a href="<?php echo esc_url($link); ?>" class="pc-card__link">
                    <div class="pc-card__content-travel">
                        <?php if ($title): ?>
                            <h3 class="pc-card__title-travel"><?php echo esc_html($title); ?></h3>
                        <?php endif; ?>

                        <?php if ($excerpt): ?>
                            <p class="pc-card__excerpt-travel"><?php echo esc_html($excerpt); ?></p>
                        <?php endif; ?>

                        <!-- Divider Line -->
                        <?php if (($title || $excerpt) && ($location || $price)): ?>
                            <div class="pc-card__divider"></div>
                        <?php endif; ?>

                        <!-- Location -->
                        <?php if ($location): ?>
                            <div class="pc-card__location">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z" fill="currentColor"/>
                                </svg>
                                <span><?php echo esc_html($location); ?></span>
                            </div>
                        <?php endif; ?>

                        <!-- Price and Button -->
                        <?php if ($price || $old_price || $button_text): ?>
                            <div class="pc-card__footer-travel">
                                <?php if ($price || $old_price): ?>
                                    <div class="pc-card__prices">
                                        <?php if ($old_price): ?>
                                            <span class="pc-card__old-price"><?php echo esc_html($old_price); ?></span>
                                        <?php endif; ?>
                                        <?php if ($price): ?>
                                            <span class="pc-card__price"><?php echo esc_html($price); ?></span>
                                        <?php endif; ?>
                                    </div>
                                <?php endif; ?>
                                <?php if ($button_text): ?>
                                    <button class="pc-card__button pc-card__button--<?php echo esc_attr($button_color_variant); ?>">
                                        <?php echo esc_html($button_text); ?>
                                    </button>
                                <?php endif; ?>
                            </div>
                        <?php endif; ?>
                    </div>
                </a>
            </article>

            <?php elseif ($card_style === 'minimal'):
                // Minimal style - Foto con etiqueta, contenido y botón
                $badge_text = !empty($card['badge_text']) ? $card['badge_text'] : '';
                $cta_text = !empty($card['cta_text']) ? $card['cta_text'] : __('Ver más', 'travel-blocks');
                $location = !empty($card['location']) ? $card['location'] : '';
                $price = !empty($card['price']) ? $card['price'] : '';
            ?>

            <article class="pc-card pc-card--minimal" data-index="<?php echo $index; ?>">
                <!-- Card Image Background -->
                <div class="pc-card__image-bg" style="background-image: url('<?php echo esc_url($image_url); ?>');">
                    <img
                        src="<?php echo esc_url($image_url); ?>"
                        alt="<?php echo esc_attr($image_alt); ?>"
                        loading="lazy"
                        style="display: none;">
                </div>

                <!-- Badge superior izquierda -->
                <?php if ($badge_text): ?>
                    <span class="pc-card__badge-minimal pc-card__badge-minimal--<?php echo esc_attr($badge_color_variant); ?>"><?php echo esc_html($badge_text); ?></span>
                <?php endif; ?>

                <!-- Card Content (Bottom Right) -->
                <a href="<?php echo esc_url($link); ?>" class="pc-card__link-minimal">
                    <div class="pc-card__content-minimal">
                        <?php if ($title): ?>
                            <h3 class="pc-card__title-minimal"><?php echo esc_html($title); ?></h3>
                        <?php endif; ?>

                        <?php if ($excerpt): ?>
                            <p class="pc-card__excerpt-minimal"><?php echo esc_html($excerpt); ?></p>
                        <?php endif; ?>

                        <!-- Divider Line -->
                        <?php if (($title || $excerpt) && ($location || $price)): ?>
                            <div class="pc-card__divider-minimal"></div>
                        <?php endif; ?>

                        <!-- Location -->
                        <?php if ($location): ?>
                            <div class="pc-card__location-minimal">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z" fill="currentColor"/>
                                </svg>
                                <span><?php echo esc_html($location); ?></span>
                            </div>
                        <?php endif; ?>

                        <!-- Price -->
                        <?php if ($price): ?>
                            <div class="pc-card__price-minimal"><?php echo esc_html($price); ?></div>
                        <?php endif; ?>

                        <!-- Botón CTA -->
                        <?php if ($cta_text): ?>
                            <span class="pc-card__cta-minimal pc-card__cta-minimal--<?php echo esc_attr($button_color_variant); ?>">
                                <?php echo esc_html($cta_text); ?>
                            </span>
                        <?php endif; ?>
                    </div>
                </a>
            </article>

            <?php elseif ($card_style === 'simple'):
                // Simple style - Foto con contenido y texto "Read more"
                $badge_text = !empty($card['badge_text']) ? $card['badge_text'] : '';
                $cta_text = !empty($card['cta_text']) ? $card['cta_text'] : __('Ver más', 'travel-blocks');
                $location = !empty($card['location']) ? $card['location'] : '';
                $price = !empty($card['price']) ? $card['price'] : '';
            ?>

            <article class="pc-card pc-card--simple" data-index="<?php echo $index; ?>">
                <!-- Card Image Background -->
                <div class="pc-card__image-bg" style="background-image: url('<?php echo esc_url($image_url); ?>');">
                    <img
                        src="<?php echo esc_url($image_url); ?>"
                        alt="<?php echo esc_attr($image_alt); ?>"
                        loading="lazy"
                        style="display: none;">
                </div>

                <!-- Badge superior izquierda -->
                <?php if ($badge_text): ?>
                    <span class="pc-card__badge-simple pc-card__badge-simple--<?php echo esc_attr($badge_color_variant); ?>"><?php echo esc_html($badge_text); ?></span>
                <?php endif; ?>

                <!-- Card Content (Bottom Right) -->
                <a href="<?php echo esc_url($link); ?>" class="pc-card__link-simple">
                    <div class="pc-card__content-simple">
                        <?php if ($title): ?>
                            <h3 class="pc-card__title-simple"><?php echo esc_html($title); ?></h3>
                        <?php endif; ?>

                        <?php if ($excerpt): ?>
                            <p class="pc-card__excerpt-simple"><?php echo esc_html($excerpt); ?></p>
                        <?php endif; ?>

                        <!-- Divider Line -->
                        <?php if (($title || $excerpt) && ($location || $price)): ?>
                            <div class="pc-card__divider-simple"></div>
                        <?php endif; ?>

                        <!-- Location -->
                        <?php if ($location): ?>
                            <div class="pc-card__location-simple">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z" fill="currentColor"/>
                                </svg>
                                <span><?php echo esc_html($location); ?></span>
                            </div>
                        <?php endif; ?>

                        <!-- Price -->
                        <?php if ($price): ?>
                            <div class="pc-card__price-simple"><?php echo esc_html($price); ?></div>
                        <?php endif; ?>

                        <!-- Texto Read More -->
                        <?php if ($cta_text): ?>
                            <span class="pc-card__read-more">
                                <?php echo esc_html($cta_text); ?>
                            </span>
                        <?php endif; ?>
                    </div>
                </a>
            </article>

            <?php else:
                // Default style - Card con badge y CTA
                $category = $card['category'] ?? '';
            ?>

            <article class="pc-card pc-card--default" data-index="<?php echo $index; ?>">
                <a href="<?php echo esc_url($link); ?>" class="pc-card__link">

                    <!-- Card Image -->
                    <div class="pc-card__image">
                        <img
                            src="<?php echo esc_url($image_url); ?>"
                            alt="<?php echo esc_attr($image_alt); ?>"
                            loading="lazy">

                        <!-- Category Badge -->
                        <?php if ($category): ?>
                            <span class="pc-card__badge pc-card__badge--<?php echo esc_attr($badge_color_variant); ?>"><?php echo esc_html($category); ?></span>
                        <?php endif; ?>
                    </div>

                    <!-- Card Content -->
                    <div class="pc-card__content">
                        <?php if ($title): ?>
                            <h3 class="pc-card__title"><?php echo esc_html($title); ?></h3>
                        <?php endif; ?>

                        <?php if ($excerpt): ?>
                            <p class="pc-card__excerpt"><?php echo esc_html($excerpt); ?></p>
                        <?php endif; ?>

                        <span class="pc-card__cta">
                            <?php _e('Ver más', 'travel-blocks'); ?>
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                                <path d="M6 12L10 8L6 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </span>
                    </div>

                </a>
            </article>

            <?php endif; ?>

            <?php endforeach; ?>
            </div>

        </div>

        <!-- Mobile Pagination Dots -->
        <?php if ($data['show_dots'] || ($data['show_arrows'] && $data['arrows_position'] === 'bottom')): ?>
            <div class="pc-dots">
                <!-- Botón izquierdo (solo para variante bottom) -->
                <?php if ($data['show_arrows'] && $data['arrows_position'] === 'bottom'): ?>
                    <button class="pc-arrow pc-arrow--prev pc-arrow--bottom" aria-label="<?php esc_attr_e('Anterior', 'travel-blocks'); ?>">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                            <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                <?php endif; ?>

                <!-- Dots -->
                <?php if ($data['show_dots']): ?>
                    <?php foreach ($cards as $i => $card): ?>
                        <button
                            class="pc-dot <?php echo $i === 0 ? 'is-active' : ''; ?>"
                            data-slide="<?php echo $i; ?>"
                            aria-label="<?php echo esc_attr(sprintf(__('Ir a card %d', 'travel-blocks'), $i + 1)); ?>">
                        </button>
                    <?php endforeach; ?>
                <?php endif; ?>

                <!-- Botón derecho (solo para variante bottom) -->
                <?php if ($data['show_arrows'] && $data['arrows_position'] === 'bottom'): ?>
                    <button class="pc-arrow pc-arrow--next pc-arrow--bottom" aria-label="<?php esc_attr_e('Siguiente', 'travel-blocks'); ?>">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                            <path d="M9 18L15 12L9 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                <?php endif; ?>
            </div>
        <?php endif; ?>

    </div>

</section>
